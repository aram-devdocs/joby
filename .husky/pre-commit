#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Running pre-commit quality checks..."

# Function to run checks in parallel
run_parallel_checks() {
  local pids=()
  local failed=0
  
  # Run lint-staged
  (
    echo "üìù Running lint-staged..."
    npx lint-staged
    echo $? > /tmp/lint-staged-status
  ) &
  pids+=($!)
  
  # Run type checking
  (
    echo "üîç Running type checks..."
    pnpm check-types
    echo $? > /tmp/type-check-status
  ) &
  pids+=($!)
  
  # Check for console.log statements
  (
    echo "üö´ Checking for console.log statements..."
    git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs -r grep -n 'console\.log' && {
      echo -e "${RED}‚ùå Found console.log statements. Please remove them before committing.${NC}"
      echo 1 > /tmp/console-check-status
    } || {
      echo 0 > /tmp/console-check-status
    }
  ) &
  pids+=($!)
  
  # Check for TODO comments
  (
    echo "üìã Checking for TODO comments..."
    git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs -r grep -n 'TODO\|FIXME\|HACK' && {
      echo -e "${YELLOW}‚ö†Ô∏è  Found TODO/FIXME/HACK comments. Consider addressing them.${NC}"
    }
  ) &
  pids+=($!)
  
  # Wait for all background jobs
  for pid in "${pids[@]}"; do
    wait "$pid"
  done
  
  # Check results
  [ -f /tmp/lint-staged-status ] && [ "$(cat /tmp/lint-staged-status)" != "0" ] && failed=1
  [ -f /tmp/type-check-status ] && [ "$(cat /tmp/type-check-status)" != "0" ] && failed=1
  [ -f /tmp/console-check-status ] && [ "$(cat /tmp/console-check-status)" != "0" ] && failed=1
  
  # Cleanup
  rm -f /tmp/lint-staged-status /tmp/type-check-status /tmp/console-check-status
  
  return $failed
}

# Run checks
if run_parallel_checks; then
  echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
else
  echo -e "${RED}‚ùå Pre-commit checks failed. Please fix the issues above.${NC}"
  exit 1
fi
