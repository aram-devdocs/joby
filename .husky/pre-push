#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸš€ Running pre-push quality gates...${NC}"

# Function to run comprehensive checks
run_push_checks() {
  local failed=0
  
  # Get the branch being pushed to
  local branch=$(git rev-parse --abbrev-ref HEAD)
  echo -e "ğŸ“ Pushing to branch: ${YELLOW}$branch${NC}"
  
  # Run full type checking
  echo -e "${BLUE}ğŸ“Š Running comprehensive type checks...${NC}"
  if ! pnpm turbo run check-types; then
    echo -e "${RED}âŒ Type checking failed${NC}"
    failed=1
  fi
  
  # Run linting
  echo -e "${BLUE}ğŸ” Running ESLint...${NC}"
  if ! pnpm turbo run lint; then
    echo -e "${RED}âŒ Linting failed${NC}"
    failed=1
  fi
  
  # Run tests with coverage
  echo -e "${BLUE}ğŸ§ª Running tests...${NC}"
  if ! pnpm turbo run test --if-present; then
    echo -e "${RED}âŒ Tests failed${NC}"
    failed=1
  fi
  
  # Run build
  echo -e "${BLUE}ğŸ”¨ Building packages...${NC}"
  if ! pnpm turbo run build; then
    echo -e "${RED}âŒ Build failed${NC}"
    failed=1
  fi
  
  # Check for uncommitted changes
  if ! git diff --quiet || ! git diff --cached --quiet; then
    echo -e "${YELLOW}âš ï¸  Warning: You have uncommitted changes${NC}"
    echo "Consider committing or stashing them before pushing."
  fi
  
  # Check for security vulnerabilities
  echo -e "${BLUE}ğŸ”’ Running security audit...${NC}"
  pnpm audit --audit-level moderate || {
    echo -e "${YELLOW}âš ï¸  Security vulnerabilities detected. Consider fixing them.${NC}"
  }
  
  return $failed
}

# Run checks
if run_push_checks; then
  echo -e "${GREEN}âœ… All pre-push checks passed! Ready to push.${NC}"
else
  echo -e "${RED}âŒ Pre-push checks failed!${NC}"
  echo -e "${YELLOW}To bypass these checks (not recommended), use: git push --no-verify${NC}"
  exit 1
fi
